{% load static %}
<!DOCTYPE html>
<html lang="en">
   <head>
      <!-- basic -->
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <!-- mobile metas -->
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta name="viewport" content="initial-scale=1, maximum-scale=1">
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <!-- site metas -->
      <title>Checkout</title>
      <meta name="keywords" content="">
      <meta name="description" content="">
      <meta name="author" content="">
      <!-- bootstrap css -->
      <link rel="stylesheet" type="text/css" href="{% static 'css/bootstrap.min.css' %}">
      <!-- style css -->
      <link rel="stylesheet" type="text/css" href="{% static 'css/style.css' %}">
      <link rel="stylesheet" type="text/css" href="{% static 'order/order.css' %}">
      <link rel="stylesheet" type="text/css" href="{% static 'css/image.css' %}">
      <!-- Responsive-->
      <link rel="stylesheet" href="{% static 'css/responsive.css' %}">
      <link rel="stylesheet" href="{% static 'css/detail_cycle.css' %}">
      <!-- fevicon -->
      <link rel="icon" href="{% static 'images/fevicon.png' %}" type="image/gif" />
      <!-- Scrollbar Custom CSS -->
      <link rel="stylesheet" href="{% static 'css/jquery.mCustomScrollbar.min.css' %}">
      <!-- Tweaks for older IEs-->
      <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css">
      <!-- owl stylesheets --> 
      <link href="https://fonts.googleapis.com/css?family=Poppins:400,700|Raleway:400,700,800&display=swap" rel="stylesheet">
      <link rel="stylesheet" href="{% static 'css/owl.carousel.min.css' %}">
      <link rel="stylesoeet" href="{% static 'css/owl.theme.default.min.css' %}">
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.5/jquery.fancybox.min.css" media="screen">
   </head>
<body>
  <div class="loader_bg">
    <div class="loader"><img src="{% static 'images/loading.gif' %}" alt="#" /></div>
 </div>
   <section class="h-100 gradient-custom">
    <div class="container py-5 h-100">
      {% include "inc/messages.html" %}

      <div class="row d-flex justify-content-center align-items-center h-100">

        <div class="col-lg-10 col-xl-8">
          
          <div class="card" style="border-radius: 10px;">
            <div class="card-header px-4 py-5">
              <h3 class="text-muted mb-0" id="username"><span style="color: #a8729a;"></span>!</h3>
            </div>
            <div class="card-body p-4">
              <div class="d-flex justify-content-between pt-2">
                <p class="fw-bold mb-0"><b>Order Details:</b></p>
                <p class="text-muted mb-0" id="total-price"><span class="fw-bold me-4"></span> </p>
              </div>
  
              <div class="d-flex justify-content-between pt-2">
                <p class="text-muted mb-0" id="created-at"><span class="fw-bold me-4">Created at </span></p>
                <p class="text-muted mb-0" id="Paid"><span class="fw-bold me-4">paid: </span></p>
              </div>
              <div class="d-flex justify-content-between mb-5">
                <p class="text-muted mb-0" id="Coupon"><span class="fw-bold me-4">Coupon:</span></p>
              </div>
           
              <select class="form-control form-control-user mb-3" id="addressDropdown">
                <option value="">Select Your Address</option>
            </select>
            
              <div class="d-flex justify-content-between mb-5">
                <form class="user" action="#" method="post" id="myForm">
                  <div class="row mb-3">
                      <div class="col-md-12">
                          <input class="form-control form-control-user mb-3" placeholder="Province" type="text" name="province" required id="province"> 
                          <div id="provinceError" style="color: red;"></div>
                      </div>
                      <div class="col-md-12">
                          <input class="form-control form-control-user mb-3" placeholder="City" type="text" name="city" required id="city"> 
                          <div id="cityError" style="color: red;"></div>
                      </div>
                      <div class="col-md-12">
                          <input class="form-control form-control-user mb-3" placeholder="Detail address" type="text" name="detail" required id="detail"> 
                          <div id="detailError" style="color: red;"></div>
                      </div>
                      <div class="col-md-12">
                          <input class="form-control form-control-user mb-3" placeholder="Postal code" type="email" name="post_code" required id="post_code"> 
                          <div id="postalError" style="color: red;"></div>
                      </div>
                  </div>
              </form>
              </div>
            
            </div>
            <div class="card-footer border-0 px-4 py-5"
              style="background-color: #43baaf; border-bottom-left-radius: 10px; border-bottom-right-radius: 10px;">
              <h5 class="d-flex align-items-center justify-content-end text-white text-uppercase mb-0">Total
                paid: <span class="h2 mb-0 ms-2" id="total-paid"></span></h5>
                <div class="col-md-12">
                  <input class="form-control form-control-user mb-3" placeholder="Coupon Code" type="text" name="coupon_code" id="coupon_code"> 
                  <!-- Display error message if needed -->
                  <div id="couponError" style="color: red;"></div>
              </div>
              <button id="applyCouponBtn" class="btn btn-primary" onclick="submitCoupon()">Apply Coupon</button><br><br>
                <a href="#" class="btn btn-success btn-lg" onclick="submitFormData()" id="payButton">Pay</a>

            </div>
            
          </div>
        </div>
      </div>
    </div>
  </section>

  <script src="{% static 'js/jquery.min.js' %}"></script>
  <script src="{% static 'js/popper.min.js' %}"></script>
  <script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
  <script src="{% static 'js/jquery-3.0.0.min.js' %}"></script>
  <!-- sidebar -->
  <script src="{% static 'js/jquery.mCustomScrollbar.concat.min.js' %}"></script>
  <script src="{% static 'js/custom.js' %}"></script>

  <script>
    var data; // Declare a global variable to hold the fetched data

    fetch('api/')
        .then(response => response.json())
        .then(data => {
            // Store the fetched data in the global variable
            console.log(data.calculate_total_price)
            document.getElementById('username').innerHTML = 'Thanks for your Order ' + data.serializer.user.first_name;
            document.getElementById('total-price').innerHTML = 'total price: ' + data.serializer.calculate_total_price;
            document.getElementById('created-at').innerHTML = 'created at ' + data.serializer.created_at;
            document.getElementById('Paid').innerHTML = 'is paid: ' + data.serializer.is_paid;
            document.getElementById('total-paid').innerHTML = data.serializer.calculate_total_price;
            data.address_data.forEach(address => {
                const option = document.createElement('option');
                option.value = address.id; 
                option.text = `${address.province}, ${address.city}, ${address.detailed_address}`;
                document.getElementById('addressDropdown').appendChild(option);
            });
            // Store the fetched data in the global variable
            this.data = data;
        })
        .catch(error => console.error('Error:', error));

    // Add event listener for dropdown change
    document.getElementById('addressDropdown').addEventListener('change', function(event) {
        var selectedAddressId = this.value;
        if (selectedAddressId) {
            var selectedAddress = data.address_data.find(address => address.id === parseInt(selectedAddressId));
            document.getElementById('province').value = selectedAddress.province;
            document.getElementById('city').value = selectedAddress.city;
            document.getElementById('detail').value = selectedAddress.detailed_address;
            document.getElementById('post_code').value = selectedAddress.postal_code;

            // Disable the input fields
            document.getElementById('province').disabled = true;
            document.getElementById('city').disabled = true;
            document.getElementById('detail').disabled = true;
            document.getElementById('post_code').disabled = true;
        } else {
            // Enable the input fields if no address is selected
            document.getElementById('province').disabled = false;
            document.getElementById('city').disabled = false;
            document.getElementById('detail').disabled = false;
            document.getElementById('post_code').disabled = false;
        }
    }); 

    function submitFormData() {
        var province = document.getElementById('province').value;
        var city = document.getElementById('city').value;
        var detail = document.getElementById('detail').value;
        var post_code = document.getElementById('post_code').value;
        var coupon_code = document.getElementById('coupon_code').value;
        var selectedAddressId = document.getElementById('addressDropdown').value;

        fetch('api/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                province: province,
                city: city,
                detailed_address: detail,
                postal_code: post_code,
                coupon_code: coupon_code,
                selected_address_id: selectedAddressId
            })
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            } else {
                throw new Error('Error:', response.statusText);
            }
        })
        .then(data => {
            window.location.href = data.redirect_url; 
        })
        .catch(error => { 
            window.location.reload();
        });
    }
    

    function submitCoupon() {
      var coupon_code = document.getElementById('coupon_code').value;

      fetch('api/', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({
              coupon_code: coupon_code,
          })
      })
      .then(response => {
          if (response.ok) {
              return response.json();
          } else {
              throw new Error('Error:', response.statusText);
          }
      })
      .then(data => {
          window.location.href = data.redirect_url; 
      })
      .catch(error => { 
          window.location.reload();
      });
  }

    document.getElementById('payButton').addEventListener('click', function(event) {
        event.preventDefault();

        if (!validateForm()) {
            return;
        }

        submitFormData();
    });

    function validateForm() {
        var province = document.getElementById('province').value;
        var city = document.getElementById('city').value;
        var detail = document.getElementById('detail').value;
        var post_code = document.getElementById('post_code').value;

        if (province.trim() === '' || city.trim() === '' || detail.trim() === '' || post_code.trim() === '') {
            return false;
        }

        return true; 
    }

    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>

</body>